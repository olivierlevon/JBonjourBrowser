# AppVeyor CI configuration for JBonjourBrowser
# https://www.appveyor.com/docs/appveyor-yml/

version: 2.0.0.0b{build}

image: Visual Studio 2022

environment:
  ANT_VERSION: 1.10.14
  ANT_HOME: C:\ant

install:
  # Install Java 21 using Chocolatey
  - choco install temurin21 -y --no-progress
  - refreshenv
  # Find and set JAVA_HOME dynamically (Temurin installs to Eclipse Adoptium folder)
  - ps: |
      $jdkPath = Get-ChildItem "C:\Program Files\Eclipse Adoptium" -Directory |
                 Where-Object { $_.Name -like "jdk-21*" } |
                 Select-Object -First 1 -ExpandProperty FullName
      if ($jdkPath) {
        Write-Host "Found JDK at: $jdkPath"
        [Environment]::SetEnvironmentVariable("JAVA_HOME", $jdkPath, "Process")
        $env:PATH = "$jdkPath\bin;$env:PATH"
      } else {
        Write-Error "JDK 21 not found!"
        exit 1
      }
  # Display Java version
  - java -version
  - javac -version
  # Download and install Apache Ant
  - ps: |
      if (!(Test-Path "C:\ant")) {
        Write-Host "Downloading Apache Ant..."
        $antUrl = "https://dlcdn.apache.org//ant/binaries/apache-ant-$env:ANT_VERSION-bin.zip"
        $antZip = "$env:TEMP\ant.zip"
        Invoke-WebRequest -Uri $antUrl -OutFile $antZip -UseBasicParsing
        Write-Host "Extracting Apache Ant..."
        Expand-Archive -Path $antZip -DestinationPath "C:\" -Force
        Rename-Item "C:\apache-ant-$env:ANT_VERSION" "C:\ant"
      }
  - SET PATH=%ANT_HOME%\bin;%PATH%
  - ant -version

build_script:
  - cd bonjour
  # Clean and compile
  - ant -f nbproject/build-impl.xml clean compile
  # Build JAR
  - ant -f nbproject/build-impl.xml jar

after_build:
  # Generate Javadoc
  - ant -f nbproject/build-impl.xml javadoc

artifacts:
  - path: bonjour\dist\JBonjourBrowser.jar
    name: JBonjourBrowser
  - path: bonjour\dist\jars\*.jar
    name: Dependencies
  - path: bonjour\dist\javadoc
    name: Javadoc
    type: zip

# No automated tests yet
test: off

# Cache Ant installation
cache:
  - C:\ant

# Deploy to GitHub Releases (only on tagged commits)
deploy:
  - provider: GitHub
    auth_token:
      secure: kv3wgBiiHK/ffSszGHFTfuuQrWarJ3+jZu7EDbl713dZb4uUoU7lBI6VevlDUe8n
    artifact: JBonjourBrowser,Dependencies,Javadoc
    draft: false
    prerelease: false
    on:
      APPVEYOR_REPO_TAG: true

# Notifications (optional)
notifications:
  - provider: Email
    on_build_success: false
    on_build_failure: true
